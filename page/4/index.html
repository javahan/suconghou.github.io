<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="generator" content="Hugo 0.21" />
	<meta charset="UTF-8">
	<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
	<meta name='renderer' content='webkit'>
	<meta name='viewport' content='width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no'>
	<meta name='description' content='记录学习的点点滴滴'>
	<meta name='keywords' content='前端,PHP,GO,编程博客'>
	<title>苏苏的博客 &middot; 苏苏的博客</title>
	<link rel="stylesheet" type="text/css" href="/css/style.min.css">
	<link href="http://blog.suconghou.cn/index.xml" rel="alternate" type="application/rss+xml" title="苏苏的博客" />
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
	<link rel="shortcut icon" href="/favicon.png">
</head>
<body>
<header class="header">
	<div class="header-main">
		<a href="/"><img src="/img/avatar.jpg" class="header-avatar"></a>
		<h1>苏苏的博客</h1>
		<p class="sub-title">简约至极</p>
		<ul class="contact">
			<a href="https://github.com/suconghou" target="_blank"><i class="fa fa-github"></i></a>
			<a href="javascript:music.show(1)"><i class="fa fa-music"></i></a>
		</ul>
	</div>
</header>

<aside></aside>

<div class="content container">
	<div class="posts">
		
		<div class="post">
			<h1 class="post-title">
				<a href="/post/some-hole/"> 都有哪些坑</a>
			</h1>
			<p class="post-date">Thu, Jul 7, 2016</p>
			<div class="post-text">
				

<h2 id="总结一下遇到的坑">总结一下遇到的坑</h2>

<h3 id="微信">微信</h3>

<p><strong>关于横竖屏的坑</strong></p>

<p>css3可以使用媒体查询判断设备是横屏还是竖屏</p>

<pre><code>//横屏时显示
@media all and (orientation : landscape) {
#screenMask{display:block}
}

//竖屏时隐藏
@media all and (orientation : portrait) {
#screenMask{display:none}
}
</code></pre>

<p>在手机浏览器中表现良好,微信中看样子也可以,但是微信网页中如果聚焦输入框,弹起键盘就有问题了.</p>

<p>软键盘弹起后,网页可用面积减小,安卓就自动识别为横屏了,原有的页面消失了,影响非常大.IOS则没有这个问题,媒体查询判断横竖屏在IOS上工作良好.</p>

<p>并且由此发现,css3媒体查询就是根据宽度是否比高度小来判断横竖屏的.</p>

<p><strong>解决方案1</strong></p>

<p>使用<code>javascript</code>的<code>orientation</code>和<code>orientationchange</code>判断</p>

<ul>
<li>window.orientation   属于window对象上一个属性；共有三个值 ：0为竖屏模式（portrait）,90为向左反转变为横屏模式（landscape），-90为向右反转变为横屏模式（landscape），最后180就是设备上下互换还是竖屏模式。</li>
<li>orientationchange    是一个event，在设备旋转时，会触发此事件，如同PC上使用的resize事件。</li>
</ul>

<pre><code>(function(){
    var init = function(){
        var updateOrientation = function(){
            var orientation = window.orientation;
            switch(orientation){
                case 90:
                case -90:
                    orientation = 'landscape';
                    break;
                default:
                    orientation = 'portrait';
                    break;
            }

           //do something
           //比如在html标签加一个状态
            //然后根据不同状态，显示不同大小
            document.body.parentNode.setAttribute('class',orientation);
        };

        window.addEventListener('orientationchange',updateOrientation,false);
        updateOrientation();
    };

    window.addEventListener('DOMContentLoaded',init,false);
})();
</code></pre>

<p>经测试使用JS判断能够正确得出安卓微信客户端里输入框聚焦时的横竖屏状态.</p>

<p>orientation和orientationchange只有移动设备有这些属性和事件.</p>

<p>在不支持这种属性和事件的设备上使用宽高比来判断做一下兼容,这样在不支持<code>orientation</code>的设备上就相当于使用了媒体查询</p>

<p>最终总结代码如下:</p>

<pre><code>(function(w)
{
    var supportOrientation = (typeof w.orientation === 'number' &amp;&amp; typeof w.onorientationchange === 'object');
    var init = function()
    {
        var htmlNode = document.body.parentNode, orientation;
        var updateOrientation = function()
        {
            if(supportOrientation)
            {
                orientation = w.orientation;
                switch(orientation)
                {
                    case 90:
                    case -90:
                        orientation = 'landscape';
                        break;
                    default:
                        orientation = 'portrait';
                        break;
                }
            }
            else
            {
                orientation = (w.innerWidth &gt; w.innerHeight) ? 'landscape' : 'portrait';
            }
            htmlNode.setAttribute('class',orientation);
        };
        if(supportOrientation)
        {
            w.addEventListener('orientationchange',updateOrientation,false);
        }
        else
        {
            //监听resize事件
            w.addEventListener('resize',updateOrientation,false);
        }
        updateOrientation();
    };
    w.addEventListener('DOMContentLoaded',init,false);
})(window);
</code></pre>

<p>可以访问如下网址测试: /html/wx</p>

			</div>
		</div>
		
		<div class="post">
			<h1 class="post-title">
				<a href="/post/php-best-way/"> PHP最佳实践</a>
			</h1>
			<p class="post-date">Thu, Jun 30, 2016</p>
			<div class="post-text">
				

<h2 id="性能优化">性能优化</h2>

<h3 id="数组相关">数组相关</h3>

<p><strong><code>in_array</code>在大数据量(数万以上元素)下效率低下</strong></p>

<p>在分析nginx log得出所有不重复IP时,采用<code>in_array</code>判断,50多万的数据耗时需要五六分钟,而采用存键的方法,用<code>isset</code>判断仅需要十几秒,效率差别非常大. [php7环境下]</p>

<p>判断一个数组是否存在某个元素,远比查找一个键消耗的要多.前者时间复杂度O(n),而后者O(1)</p>

<p>即时使用<code>in_array</code>,也需要加上第三个参数,设置为严格模式,省略数据类型转化的开销,设置为<code>true</code>比设置为<code>false</code>性能要提升好几倍.</p>

<p>这种情况下使用<code>array_search</code>情况比<code>in_array</code>更加糟糕</p>

<p>如果条件允许使用<code>array_flip</code>交换键值,在用<code>isset</code>来判断要比<code>in_array</code>好得多</p>

<p>同时,使用<code>isset</code>来判断数组的键,也比使用<code>array_key_exists</code>要好</p>

<p>而对于本题,还可以使用<code>array_unique</code>最后去重,用空间换时间,效率仅次于用<code>isset</code></p>

<h2 id="bugs">Bugs</h2>

<h3 id="php-pdo-mysql-server-has-gone-away">php pdo <code>MySQL server has gone away</code></h3>

<p>在使用PDO长连接时,执行过一次PDO初始化后,php-fpm进程会与mysql server开启一条TCP长连接,下次连接数据库就能加快速度.</p>

<p>但是却存在一定问题,PDO维持了长连接并没有较好的检测其可用性,如果mysql server kill 掉这个连接,或者mysql重启,都会造成</p>

<p>重新实例化PDO时得到旧的链接,导致出现<code>MySQL server has gone away</code>,更让人郁闷的是这个错误并不是一个Exception,无法被catch捕获,即使设置<code>PDO::ATTR_ERRMODE=&gt;PDO::ERRMODE_EXCEPTION</code>,也不行,还是直接在页面上提示.</p>

<p>如果你使用了<code>set_error_handler</code>,那么这个<code>Warning</code>将会被捕捉,不会直接显示在页面上,但也改变了程序的原有执行逻辑.</p>

<p>如果你不使用<code>set_error_handler</code>,页面上报出<code>Warning</code>,但其实PDO已经返回一个可用的链接了.</p>

<p>猜测可能是PDO首先得到了不可用的然后报警告,然后又创建了一个新的.</p>

<p>较好的解决方法是设置<code>set_error_handler</code>若捕获了这个<code>MySQL server has gone away</code>,则返回null,程序继续按原有逻辑执行.</p>

<p>或者不使用PDO长连接.</p>

<p>注意,<code>set_error_handler</code>返回false的话,这个错误还是会被交到上一级错误程序处理的.</p>

<h3 id="编码转换中的若干问题">编码转换中的若干问题</h3>

<p>我们经常会遇到将utf8编码字符转化为gbk编码的字符,例如生成csv表格,在windows上的cmd窗口输出文字,以及操作windows上的有关文件路径的操作都需要使用gbk编码.</p>

<p>常使用<code>iconv('utf-8', 'gbk', $str);</code>将utf8字符转为gbk</p>

<p>这里 utf gbk 不区分大小写,也可以混写,不区分是<code>utf8</code>还是<code>utf-8</code>,都能都正常使用</p>

<p><code>iconv('utf-8', 'gbk//ignore', $str);</code> 加上<code>//ignore</code>使有些字符无法装换时略过.</p>

<p>但是<code>//ignore</code>在php5.4及以下,和个别php5.6版本上无效,任然是报NOTICE错误.</p>

<pre><code>&lt;?php
	echo iconv('UTF8', 'GBK//IGNORE', 'l l l');
?&gt;
</code></pre>

<p>见 <code>https://3v4l.org/7vCFW</code> 和 <code>http://www.php.net/manual/en/function.iconv.php</code>第一条评论</p>

<p>可以考虑使用<code>$content = mb_convert_encoding($content, &quot;GBK&quot;,&quot;UTF-8&quot;);</code> 从UTF8转为GBK</p>

<p>这样不会报错,不能装换的被替换为?,参数也是不区分大小写,utf8和utf-8</p>

<h3 id="filter-var-filter-validate-url">filter_var FILTER_VALIDATE_URL</h3>

<p>filter_var FILTER_VALIDATE_URL 中不能包含中文,包含中文被判定为false</p>

<h3 id="内存是拷贝还是内存引用">内存是拷贝还是内存引用</h3>

<p>例1</p>

<pre><code>$a=str_repeat('hello world',81920);
echo intval(memory_get_usage()/1024);
</code></pre>

<p>例2</p>

<pre><code>$a=str_repeat('hello world',81920);
$b=$a;
$c=$a;
$d=$a;
echo intval(memory_get_usage()/1024);

</code></pre>

<p>例3</p>

<pre><code>$a=str_repeat('hello world',81920);
$b=$a.'';
$c=$a.'';
$d=$a.'';
echo intval(memory_get_usage()/1024);
</code></pre>

<p>例1与例2,内存差距基本不大,例2与例3有较大差距,例3约为例2的3倍,但小于3倍</p>

<p>一般数据类型</p>

<p>php在内存上是写时拷贝,一个变量复制多份内存不会占用多份,只有变量被改变时才会新申请一份内存给此变量.</p>

<h3 id="memcached-中的问题">Memcached 中的问题</h3>

<p>如果你安装了php的<code>memcached</code>扩展,但是<code>igbinary</code>扩展没有被启用,</p>

<p>会使得memcache存储简单数据类型没有问题,但是存储复杂数据类型,如数组等,便会出现问题,</p>

<p>对一个复杂数据类型的set将会导致php worker进程崩溃,类似<code>[pool www] child 4573 exited on signal 5 (SIGTRAP) after 20.831438 seconds from start</code></p>

<p>nginx将会收到类似<code>upstream prematurely closed connection while reading response header from upstream</code>,用户看到的将是502错误.</p>

<p>故启用<code>memcached</code>时最好启用<code>igbinary</code></p>

<h3 id="php-worker">php worker</h3>

<p>python 简单的空worker 消耗内存比php空worker更少,但是随着python<code>import</code>的模块增加,消耗的内存也随之上升,</p>

<p><code>import</code>大多数常用模块后,内存消耗较php稍大,php进程只有业务处理会波动内存,python的CPU占用明显比php高.</p>

<p>但python有多线程,多线程下内存消耗也较少,都适合写一些worker,相比之下,node的worker占用较多内存,引入常用模块后内存更是占用更大,CPU占用也比PHP多,优点是异步可以媲美多线程</p>

<h3 id="domdocument-loadhtml-内存泄漏">DOMDocument loadHTML 内存泄漏</h3>

<p>在大量使用DOMDocument的loadHTML后,php的进程占用内存不断增长,最终内存泄漏被强行杀死.</p>

<p>其实这是<code>libxml_use_internal_errors</code>所引起的问题,<code>loadHTML</code>产生的警告被内部收集,但没有清除,所以一直堆积.</p>

<p>见 <a href="http://stackoverflow.com/questions/8379829/domdocument-php-memory-leak">http://stackoverflow.com/questions/8379829/domdocument-php-memory-leak</a></p>

<h3 id="php-gzip-压缩">php gzip 压缩</h3>

<p>压缩函数：gzcompress gzdeflate gzencode</p>

<p>解压函数：gzuncompress gzinflate gzdecode</p>

<p>他们都有第三个参数,并且第三个参数相同时,产生的结果也相同,其实他们都是使用了DEFLATE压缩算法,第三个参数控制他们压缩后添加的一些其他信息,只不过默认参数不同.</p>

<p>ZLIB_ENCODING_RAW 对应于纯DEFLATE格式；
ZLIB_ENCODING_GZIP 对应于GZIP格式；
ZLIB_ENCODING_DEFLATE 对应于ZLIB格式（注意不是纯DEFLATE格式）</p>

<p>默认配置下压缩后大小 gzdeflate &lt; gzcompress &lt; gzencode</p>

<p>大小差别是6字节,12字节,18字节</p>

<p>函数 <code>readgzfile</code>类似于<code>readfile</code>但是可以在输出之前解压然后输出</p>

<p>Content-Encoding:deflate  对应于 gzdeflate</p>

<h2 id="foreach-vs-array-filter">foreach vs array_filter</h2>

<p>大数据量下,使用foreach过滤数组控制不如用array_filter,array_filter不加第二个参数,默认就是返回值,可用作去除非true值.</p>

<p>array_filter加上array_values也要比foreach快,在php7下更加明显</p>

<p>在php7之前的foreach其实是复制出一个副本出来，然后进行循环的。这个时候建议使用array_map(), array_walk(), array_filter()等函数来处理你的问题</p>

<h2 id="php5-与-php7">php5 与 php7</h2>

<p>php5下关键字<code>list</code>既不能作为一个函数也不能作为一个方法,也不能作为一个类.</p>

<p>在php7下有了改善,能作为一个类中的方法了.</p>

<h2 id="array-merge-vs-array-array">array_merge vs array+array</h2>

<p><a href="http://stackoverflow.com/questions/7059721/array-merge-versus">http://stackoverflow.com/questions/7059721/array-merge-versus</a></p>

<h2 id="正则-w匹不匹配中文">正则\w匹不匹配中文</h2>

<p>\w在ASCII下等价于[A-Za-z0-9_],在Unicode下表示字符(包括汉字)和数字和下划线.</p>

<p><code>/\w+/u</code> 不添加u修饰符是不能匹配汉字的.</p>

<p>匹配全是汉字的正则<code>/^[\x{4e00}-\x{9fa5}]+$/u</code></p>

<p>Unicode的中文字范围是u4e00-u9fa5，4e00对应的字是&rdquo;一&rdquo;,9fa5对应的汉字是&rdquo;龥&rdquo;</p>

<p><code>/[\x{4e00}-\x{9fa5}]/u</code> 等同于 <code>/[一-龥]/u</code></p>

<h2 id="readfile-stream-copy-to-stream">readfile stream_copy_to_stream</h2>

<p>大文件操作</p>

			</div>
		</div>
		
		<div class="post">
			<h1 class="post-title">
				<a href="/post/shadowsocks-libev/"> shadowsocks libev</a>
			</h1>
			<p class="post-date">Wed, May 18, 2016</p>
			<div class="post-text">
				

<h2 id="静态编译shadowsocks-libev">静态编译shadowsocks libev</h2>

<p>在alpine里编译</p>

<p>先安装依赖</p>

<pre><code># Installation of Libsodium
cd /tmp
export LIBSODIUM_VER=1.0.12
wget https://download.libsodium.org/libsodium/releases/libsodium-$LIBSODIUM_VER.tar.gz
tar xvf libsodium-$LIBSODIUM_VER.tar.gz
cd libsodium-$LIBSODIUM_VER
./configure --prefix=/usr &amp;&amp; make -j2 &amp;&amp; make install
cd /tmp
ldconfig

# Installation of MbedTLS
cd /tmp
export MBEDTLS_VER=2.4.2
wget https://tls.mbed.org/download/mbedtls-$MBEDTLS_VER-gpl.tgz
tar xvf mbedtls-$MBEDTLS_VER-gpl.tgz
cd mbedtls-$MBEDTLS_VER
make SHARED=1 CFLAGS=-fPIC &amp;&amp; make DESTDIR=/usr install
cd /tmp
ldconfig
</code></pre>

<p>安装完这两个依赖后,下面准备开始静态编译</p>

<pre><code>apk update &amp;&amp; apk upgrade &amp;&amp; apk add gcc g++ make autoconf curl wget build-base linux-headers libev-dev libtool udns-dev libsodium-dev mbedtls-dev pcre-dev
SS_VER=3.0.6
cd /tmp
curl -sSL https://github.com/shadowsocks/shadowsocks-libev/releases/download/v${SS_VER}/shadowsocks-libev-${SS_VER}.tar.gz |  tar xz --strip 1
CFLAGS=-Os ./configure --prefix=/usr --enable-static --disable-documentation
sed -i &quot;s/LDFLAGS = /LDFLAGS = -all-static/g&quot; ./src/Makefile
sed -i &quot;s/LDFLAGS = /LDFLAGS = -all-static/g&quot; ./Makefile
</code></pre>

<p>其中 需要 <code>libudns.a</code> 可以到<code>http://www.corpit.ru/mjt/udns.html</code>下载编译</p>

<pre><code>curl -sSL http://www.corpit.ru/mjt/udns/udns-0.4.tar.gz | tar xz &amp;&amp; cd udns-0.4 &amp;&amp; ./configure  &amp;&amp; make -j2
</code></pre>

<p>复制编译好的<code>libudns.a</code>到<code>/usr/lib/libudns.a</code></p>

<p>make 之前需要存在以下文件<code>/usr/lib/libev.a /usr/lib/libsodium.a /usr/lib/libmbedcrypto.a  /usr/lib/libpcre.a  /usr/lib/libudns.a</code></p>

<p><code>make -j2</code>编译完成后即可在src目录得到静态编译的ss-local,ss-server等</p>

<h3 id="使用">使用</h3>

<p>启动server端</p>

<p><code>ss-server -s 0.0.0.0 -p 443 -k 123456 -m rc4-md5 -t 300 -d 8.8.8.8 -u</code></p>

<p>with Linux kernel &gt; 3.7.0 可以加上<code>--fast-open</code></p>

<p><code>ss-server -s 0.0.0.0 -p 443 -k 123456 -m rc4-md5 -t 300 -d 8.8.8.8 --fast-open -u</code></p>

<p>后台运行:</p>

<p><code>ss-server -s 0.0.0.0 -p 443 -k 123456 -m rc4-md5 -t 300 -d 8.8.8.8 -u &gt; /tmp/ss.log 2&gt;&amp;1 &amp;</code></p>

<p><strong>GO语言版本的也十分方便哦</strong></p>

<p>这里提供一个基于<code>docker</code>的go语言版本,<a href="https://hub.docker.com/r/suconghou/shadowsocks/">docker go shadowsocks</a>,只有3.3MB
十分方便</p>

<p>同时也含有libev版本的可供选择</p>

<h2 id="网络内核参数优化">网络内核参数优化</h2>

<p>修改<code>ulimit</code></p>

<p><code>ulimit -n</code> 可以查看当前的</p>

<p><code>vim /etc/security/limits.conf</code></p>

<p>添加一下两行</p>

<pre><code>* soft nofile 51200
* hard nofile 51200
</code></pre>

<p>KVM 和 XEN 可以修改内核,明显提升网络环境差的情况下的表现,使用<code>hybla</code>控制算法,效果明显,能提速30%</p>

<p><code>/etc/sysctl.conf</code></p>

<pre><code>net.core.somaxconn = 4096
net.netfilter.nf_conntrack_max = 64000
fs.file-max = 51200
#提高整个系统的文件限制
net.ipv4.tcp_syncookies = 1
#表示开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN攻击，默认为0，表示关闭；
net.ipv4.tcp_tw_reuse = 1
#表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；
net.ipv4.tcp_tw_recycle = 0
#表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭；
#为了对NAT设备更友好，建议设置为0。
net.ipv4.tcp_fin_timeout = 30
#修改系統默认的 TIMEOUT 时间。
net.ipv4.tcp_keepalive_time = 1200
#表示当keepalive起用的时候，TCP发送keepalive消息的频度。缺省是2小时，改为20分钟。
net.ipv4.ip_local_port_range = 10000 65000 #表示用于向外连接的端口范围。缺省情况下很小：32768到61000，改为10000到65000。（注意：这里不要将最低值设的太低，否则可能会占用掉正常的端口！）
net.ipv4.tcp_max_syn_backlog = 8192
#表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多等待连接的网络连接数。
net.ipv4.tcp_max_tw_buckets = 5000
#表示系统同时保持TIME_WAIT的最大数量，如果超过这个数字，TIME_WAIT将立刻被清除并打印警告信息。
#额外的，对于内核版本新于**3.7.1**的，我们可以开启tcp_fastopen：
net.ipv4.tcp_fastopen = 3

#increase TCP max buffer size settable using setsockopt()
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
#increase Linux autotuning TCP buffer limit
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
#increase the length of the processor input queue
net.core.netdev_max_backlog = 250000
#recommended for hosts with jumbo frames enabled
net.ipv4.tcp_mtu_probing=1
#使用拥塞算法Hybla
net.ipv4.tcp_congestion_control = hybla
</code></pre>

<p>然后<code>sysctl -p</code>使之生效</p>

<p>也可以使用命令使本次生效</p>

<p><code>sysctl -w net.ipv4.tcp_congestion_control=hybla</code></p>

<p><code>sysctl -w net.ipv4.tcp_fastopen=3</code></p>

<p>可参见 <a href="https://github.com/Long-live-shadowsocks/shadowsocks/wiki/Optimizing-Shadowsocks">https://github.com/Long-live-shadowsocks/shadowsocks/wiki/Optimizing-Shadowsocks</a></p>

<p>OPENVZ只能修改</p>

<pre><code>net.core.somaxconn = 4096
net.ipv4.tcp_syncookies = 1
net.netfilter.nf_conntrack_max = 64000
</code></pre>

<p>使用kcptun加速</p>

<p>服务器上</p>

<pre><code>alias kcptun_start='server_linux_amd64 -t 127.0.0.1:443 -l :4433 -sndwnd 2048 -rcvwnd 2048 -mode fast2 &gt; /var/log/kcptun.log 2&gt;&amp;1 &amp; '

</code></pre>

<p>客户机上</p>

<pre><code>alias kcptun_start='kcptun_client -r 192.243.115.210:4433 -l :4433 -sndwnd 2048 -rcvwnd 2048 -mode fast2 &gt; /var/log/kcptun.log 2&gt;&amp;1 &amp;'

</code></pre>

<h2 id="python-版本">python 版本</h2>

<p>升级pip本身</p>

<pre><code>pip install --upgrade pip
</code></pre>

<pre><code>pip install shadowsocks --upgrade
</code></pre>

<p><code>--upgrade 同 -U</code> 代表如果已安装则升级到最新版</p>

<p><code>/etc/systemd/system/</code>目录下<code>shadowsocks.service</code></p>

<pre><code>[Unit]
Description=Shadowsocks

[Service]
TimeoutStartSec=0
ExecStart=/usr/bin/ssserver -c /etc/shadowsocks.json

[Install]
WantedBy=multi-user.target
</code></pre>

<h3 id="使用-kcptun-加速">使用 kcptun 加速</h3>

<p><code>https://github.com/xtaci/kcptun</code> go语言编写,直接下载使用即可</p>

<pre><code>alias kcptun_start='server_linux_amd64 -t 127.0.0.1:443 -l :serverPort -sndwnd 2048 -rcvwnd 2048 -mode fast2 &gt; /var/log/kcptun.log 2&gt;&amp;1 &amp; '
</code></pre>

<p>client端: <code>client_linux_amd64 -r serverIp:serverPort -l :443 -sndwnd 2048 -rcvwnd 2048 -mode fast2</code></p>

<p>kcptun 使用<code>udp</code>通信,监听的udp端口,未开启tcp端口. <code>python shadowsocks</code>是tcp端口和udp端口都开启.</p>

<p>使用<code>netstat -anlup</code>查看本机的udp端口使用情况,远端可以使用nc测试UDP端口 <code>nc -vuz  172.168.1.3 137</code></p>

<p>配置文件的json格式参见 <code>http://zhangyongcun.com/2016/11/22/使用-Kcptun-加速-shadowsocks/</code></p>

<p>client <code>wget http://share.suconghou.cn/files/shadowsocks/kcp/client_config.json</code></p>

<p>server <code>wget http://share.suconghou.cn/files/shadowsocks/kcp/server_config.json</code></p>

<p><code>server_config.json</code></p>

<p><code>/etc/systemd/system/kcpserver.service</code></p>

<pre><code>[Unit]
Description=kcptun-server

[Service]
TimeoutStartSec=0
ExecStart=/usr/local/bin/server_linux_amd64 -c /etc/server_config.json

[Install]
WantedBy=multi-user.target
</code></pre>

<h3 id="统计ss当前的链接">统计ss当前的链接</h3>

<p>统计当前连接ss的客户端,并统计连接数</p>

<p><code>netstat -nat | grep &quot;192.168.1.3:443&quot; |awk '{print $5}'|awk -F: '{print $1}'|sort|uniq -c|sort -nr|head -20</code></p>

			</div>
		</div>
		
		<div class="post">
			<h1 class="post-title">
				<a href="/post/tcpdump/"> 使用tcpdump与ngrep</a>
			</h1>
			<p class="post-date">Mon, May 16, 2016</p>
			<div class="post-text">
				

<p>各版本 <code>http://www.tcpdump.org/release/</code></p>

<p>安装依赖 <code>yum install -y flex gcc make byacc</code> or <code>apt-get install flex gcc make byacc wget bzip2</code></p>

<pre><code>cd /tmp
wget http://www.tcpdump.org/release/libpcap-1.7.4.tar.gz
tar zxf libpcap-1.7.4.tar.gz
cd libpcap-1.7.4
./configure --prefix=/tmp/lib
make -j4 &amp;&amp; make install
cd ../
wget http://www.tcpdump.org/release/tcpdump-4.7.4.tar.gz
tar zxf tcpdump-4.7.4.tar.gz
cd tcpdump-4.7.4
./configure --prefix=/tmp  --disable-ipv6 CFLAGS='-O3 -I/tmp/lib/include' LDFLAGS='-L/tmp/lib/lib/libpcap.a'
make -j4
make install
</code></pre>

<p>安装成功后,位于<code>ls -lh /tmp/sbin/tcpdump</code> <code>ldd</code>查看此文件依赖较少,可直接复制到其他Linux上使用.</p>

<p>采用<code>CFLAGS=&quot;-O3&quot;</code>编译后为1.2MB</p>

<p><code>tcpdump -h</code> 查看版本号以及用法</p>

<p>我编译好的tcpdump version 4.7.4</p>

<blockquote>
<p>64位 <a href="http://share.suconghou.cn/files/bin/tcpdump.xz">http://share.suconghou.cn/files/bin/tcpdump.xz</a></p>
</blockquote>

<p>也可以直接<code>yum install tcpdump</code></p>

<h2 id="使用tcpdump">使用tcpdump</h2>

<blockquote>
<p>-a 　　　将网络地址和广播地址转变成名字；</p>

<p>-d 　　　将匹配信息包的代码以人们能够理解的汇编格式给出；</p>

<p>-dd 　　 将匹配信息包的代码以c语言程序段的格式给出；</p>

<p>-ddd 　　将匹配信息包的代码以十进制的形式给出；</p>

<p>-e 　　　在输出行打印出数据链路层的头部信息；</p>

<p>-f 　　　将外部的Internet地址以数字的形式打印出来；</p>

<p>-l 　　　使标准输出变为缓冲行形式；</p>

<p>-n 　　　不把网络地址转换成名字；</p>

<p>-t 　　　在输出的每一行不打印时间戳；</p>

<p>-v 　　　输出一个稍微详细的信息，例如在ip包中可以包括ttl和服务类型的信息；</p>

<p>-vv 　　 输出详细的报文信息；</p>

<p>-c 　　　在收到指定的包的数目后，tcpdump就会停止；</p>

<p>-F 　　　从指定的文件中读取表达式,忽略其它的表达式；</p>

<p>-i 　　　指定监听的网络接口；</p>

<p>-r 　　　从指定的文件中读取包(这些包一般通过-w选项产生)；</p>

<p>-w 　　　直接将包写入文件中，并不分析和打印出来；</p>

<p>-T 　　　将监听到的包直接解释为指定的类型的报文，常见的类型有rpc （远程过程调用）和snmp（简单网络管理协议；</p>
</blockquote>

<p><code>tcpdump host 210.27.48.1</code></p>

<p><code>-A</code>和<code>-X</code>有助于你查看详细的报文数据</p>

<h2 id="ngrep">ngrep</h2>

<p>ngrep 编译总是出问题,建议直接安装:<code>apt-get install ngrep</code> <code>yum install ngrep</code></p>

<p>如果更关注于TCP流量内容,可以使用<code>ngrep</code>,他是grep命令的网络版,同样需要libpcap库,能识别TCP、UDP和ICMP包，理解bpf的过滤机制</p>

<p><code>ngrep -W byline -d eno1 port 80</code></p>

<p>用-d指定网卡,使用<code>ifconfig</code>可以查看网卡信息</p>

<pre><code>-e ：显示空数据包
-i ：忽略大小写
-v ：反转匹配
-R ：don't do privilege revocation logic
-x ：以16进制格式显示
-X ：以16进制格式匹配
-w ：整字匹配
-p ：不使用混杂模式
-l ：make stdout line buffered
-D ：replay pcap_dumps with their recorded time intervals
-t ：在每个匹配的包之前显示时间戳
-T ：显示上一个匹配的数据包之间的时间间隔
-M ：仅进行单行匹配
-I ：从文件中读取数据进行匹配
-O ：将匹配的数据保存到文件
-n ：仅捕获指定数目的数据包进行查看
-A ：匹配到数据包后dump随后的指定数目的数据包
-s ：set the bpf caplen
-S ：set the limitlen on matched packets
-W ：设置显示格式byline将解析包中的换行符
-c ：强制显示列的宽度
-q ：is be quiet (don’t print packet reception hash marks)静默模式，如果没有此开关，未匹配的数据包都以&quot;#&quot;显示
-P ：set the non-printable display char to what is specified
-F ：使用文件中定义的bpf(Berkeley Packet Filter)
-N ：显示由IANA定义的子协议号
-d ：使用哪个网卡，可以用-L选项查询
-L ：查询网卡接口

</code></pre>

<p>如果需要匹配关键字可以在-d参数之后, port 参数之前添加字符串匹配</p>

<p>同时可以使用-i忽略大小写,-w整字匹配等</p>

<p><code>sudo ngrep  -W byline -d en0 -iw &quot;easy&quot;  port 80</code></p>

<p>还可以使用这种过滤 <code>host www.google.com and port 80</code></p>

<p>具体使用见
<a href="http://man.linuxde.net/ngrep">http://man.linuxde.net/ngrep</a></p>

			</div>
		</div>
		
		<div class="post">
			<h1 class="post-title">
				<a href="/post/use-apache-traffic-server/"> 编译安装Apache Traffic Server</a>
			</h1>
			<p class="post-date">Mon, May 9, 2016</p>
			<div class="post-text">
				

<h2 id="编译安装">编译安装</h2>

<p>Centos下编译安装</p>

<pre><code>yum update -y &amp;&amp; yum install wget gcc g++ gcc-c++ glibc-headers perl openssl openssl-devel tcl-devel libxml2-devel pcre-devel
wget http://apache.fayea.com/trafficserver/trafficserver-6.1.1.tar.bz2
tar xvjf trafficserver-6.1.1.tar.bz2
cd trafficserver-6.1.1
./configure
make &amp;&amp; make install
useradd -s /sbin/nologin trafficserver
</code></pre>

<p>Apache镜像<a href="http://archive.apache.org/dist/">http://archive.apache.org/dist/</a></p>

<p>国内Apache镜像<a href="http://apache.fayea.com/">http://apache.fayea.com/</a></p>

<p>编译完成后,就可以使用了,默认是安装在<code>/usr/local/bin</code>,编译后是比较大</p>

<pre><code>total 98M
-rwxr-xr-x 1 root root 692K May  9 14:30 header_rewrite_test
-rwxr-xr-x 1 root root 520K May  9 14:30 traffic_cop
-rwxr-xr-x 1 root root 1.9M May  9 14:30 traffic_crashlog
-rwxr-xr-x 1 root root 259K May  9 14:30 traffic_ctl
-rwxr-xr-x 1 root root 1.9M May  9 14:30 traffic_layout
-rwxr-xr-x 1 root root  41K May  9 14:30 traffic_line
-rwxr-xr-x 1 root root 4.4M May  9 14:30 traffic_logcat
-rwxr-xr-x 1 root root 5.0M May  9 14:30 traffic_logstats
-rwxr-xr-x 1 root root 4.7M May  9 14:30 traffic_manager
-rwxr-xr-x 1 root root  37M May  9 14:30 traffic_sac
-rwxr-xr-x 1 root root  43M May  9 14:30 traffic_server
-rwxr-xr-x 1 root root  42K May  9 14:30 traffic_via
-rwxr-xr-x 1 root root  18K May  9 14:30 trafficserver
-rwxr-xr-x 1 root root 2.1K May  9 14:30 tspush
-rwxr-xr-x 1 root root 5.7K May  9 14:30 tsxs

</code></pre>

<p>运行<code>traffic_server -R 1</code>执行测试,经过一系列测试后,显示</p>

<pre><code>Tests Passed: 177
Tests Failed: 0
    REGRESSION_RESULT PARENTSELECTION:                          PASSED
REGRESSION_TEST DONE: PASSED
</code></pre>

<p>全部测试通过</p>

<h2 id="使用">使用</h2>

<p>默认的配置文件存放在<code>/usr/local/etc/trafficserver</code></p>

<pre><code>drwxr-xr-x 3 nobody nobody 1.0K May  9 14:30 body_factory
-rw-r--r-- 1 nobody nobody 1.7K May  9 14:30 cache.config
-rw-r--r-- 1 nobody nobody  657 May  9 14:30 cluster.config
-rw-r--r-- 1 nobody nobody 1.9K May  9 14:30 congestion.config
-rw-r--r-- 1 nobody nobody  746 May  9 14:30 hosting.config
-rw-r--r-- 1 nobody nobody 1.8K May  9 14:30 icp.config
-rw-r--r-- 1 nobody nobody 1.2K May  9 14:30 ip_allow.config
-rw-r--r-- 1 nobody nobody  328 May  9 14:30 log_hosts.config
-rw-r--r-- 1 nobody nobody  17K May  9 14:30 logs_xml.config
-rw-r--r-- 1 nobody nobody 1.4K May  9 14:30 parent.config
-rw-r--r-- 1 nobody nobody  261 May  9 14:30 plugin.config
-rw-r--r-- 1 nobody nobody  13K May  9 14:30 records.config
-rw-r--r-- 1 nobody nobody 8.6K May  9 14:30 remap.config
-rw-r--r-- 1 nobody nobody 1.7K May  9 14:30 socks.config
-rw-r--r-- 1 nobody nobody 2.1K May  9 14:30 splitdns.config
-rw-r--r-- 1 nobody nobody 2.7K May  9 14:30 ssl_multicert.config
-rw-r--r-- 1 nobody nobody  76K May  9 14:30 stats.config.xml
-rw-r--r-- 1 nobody nobody 1.9K May  9 14:30 storage.config
-rw-r--r-- 1 root   root     19 May  9 14:30 trafficserver-release
-rw-r--r-- 1 nobody nobody  649 May  9 14:30 vaddrs.config
-rw-r--r-- 1 nobody nobody 1.3K May  9 14:30 volume.config

</code></pre>

<p><code>records.config</code>负责大部分全局的选项设置，即主要配置文件</p>

<pre><code>CONFIG proxy.config.reverse_proxy.enabled INT 1                           # 开启反向代理
CONFIG proxy.config.url_remap.remap_required INT 1                        # 1 代理反向代理，0代表正向+反向代理
CONFIG proxy.config.http.cache.http INT 1                                 # 打开http缓存功能
CONFIG proxy.config.cache.ram_cache.size INT 512M                         # RAM 缓存大小
CONFIG proxy.config.http.keep_alive_no_activity_timeout_out INT 120       # 当一个事务结束后同原服务器保持连接的时间
CONFIG proxy.config.cluster.ethernet_interface STRING eth0                # 修改成需要侦听的interface名称

</code></pre>

<p><code>remap.config</code>定义映射规则，用于请求的重定向（rewrite）,反向代理即在此配置</p>

<p><code>storage.config</code> 用于指定磁盘存储</p>

<p>启动<code>trafficserver start</code></p>

<h3 id="varnish编译">varnish编译</h3>

<p>alpine中编译</p>

<pre><code>apk update &amp;&amp; apk upgrade
apk --update add gcc g++ make wget curl m4 automake autoconf libtool linux-headers py-docutils ncurses-dev pcre-dev libedit-dev
cd /tmp
VARNISH_VERSION=varnish-4.1.3
CPU_NUM=`cat /proc/cpuinfo | grep processor | wc -l`
wget https://repo.varnish-cache.org/source/${VARNISH_VERSION}.tar.gz
tar xzf ${VARNISH_VERSION}.tar.gz
cd ${VARNISH_VERSION}
./configure
make CFLAGS=&quot;-Os&quot; CPPFLAGS=-D__NEED_mode_t -j$CPU_NUM &amp;&amp; make install
strip -s /usr/local/bin/* /usr/local/sbin/* /usr/local/lib/varnish/*.so /usr/local/lib/varnish/vmods/*.so
varnishd  -V
</code></pre>

<h4 id="varnish基本使用">varnish基本使用</h4>

<p>varnish / squid / nginx 优缺点讨论 见 <a href="http://www.zhihu.com/question/20143441">http://www.zhihu.com/question/20143441</a></p>

			</div>
		</div>
		
	</div>
	<nav>
		

<ul class="pagination">
    
    <li>
        <a href="/" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
    </li>
    
    <li
    >
    <a href="/page/3/" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
    </li>
    
    
    
    
    
     
        
        
    
    
    <li
    ><a href="/">1</a></li>
    
    
    
    
    
     
        
        
    
    
    <li
    ><a href="/page/2/">2</a></li>
    
    
    
    
    
     
        
        
    
    
    <li
    ><a href="/page/3/">3</a></li>
    
    
    
    
    
     
        
        
    
    
    <li
    class="active"><a href="/page/4/">4</a></li>
    
    
    
    
    
     
        
        
    
    
    <li
    ><a href="/page/5/">5</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="disabled"><span aria-hidden="true">&hellip;</span></li>
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
     
        
        
    
    
    <li
    ><a href="/page/9/">9</a></li>
    
    
    <li
    >
    <a href="/page/5/" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
    </li>
    
    <li>
        <a href="/page/9/" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
    </li>
    
</ul>

	</nav>
</div>
	<div class="music-container">
	<div class="music-header">
	    <a class="fa-button home" href="javascript:music.show(0)"><i class="fa fa-home" title="Home"></i></a>
	    <a class="fa-button next" href="javascript:music.next()"><i class="fa fa-chevron-right" title="Next"></i></a>
	</div>
	<div class="backdrop"></div>
	<div class="music-player">
		<div class="cover">
            <img src="http://p4.music.126.net/ckfEE9UUGcnGHylQJ12ENA==/670702092966093.jpg?param=350y350">
            <div class="foredrag"><i class="fa fa-play"></i></div>
        </div>
        <div class="progress">
            <div class="elapse"></div>
        </div>
        <div class="detail">
            <div class="title">音乐标题</div>
            <div class="artist">歌手</div>
        </div>
	</div>
</div>
<div id="loader" style="z-index:99999;" class="pageload-overlay" data-opening="M 40 -21.875 C 11.356078 -21.875 -11.875 1.3560784 -11.875 30 C -11.875 58.643922 11.356078 81.875 40 81.875 C 68.643922 81.875 91.875 58.643922 91.875 30 C 91.875 1.3560784 68.643922 -21.875 40 -21.875 Z">
    <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 80 60" preserveAspectRatio="xMidYMid slice"> <path d="M40,30 c 0,0 0,0 0,0 0,0 0,0 0,0 0,0 0,0 0,0 0,0 0,0 0,0 Z"/></svg>
</div>

	<footer class="footer">
		<div class="footer-nav">
			<ul>
				<li><a href="/post/">归档</a></li>
				<li><a href="/">专题</a></li>
				<li><a href="/life/">生活</a></li>
				<li><a href="/about/">关于</a></li>
			</ul>
		</div>
	</footer>
	<script type="text/javascript" src="/js/main.min.js" data-no-instant></script>
</body>
</html>

