<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
	<meta name='renderer' content='webkit'><meta name='viewport' content='width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no'>
	<title> &middot; </title>
	<link rel="stylesheet" type="text/css" href="/css/style.min.css">
	<link href="" rel="alternate" type="application/rss+xml" title="" />
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
	<link rel="shortcut icon" href="/favicon.png">
</head>
<body>
<header class="header">
	<div class="header-main">
		<a href="/"><img src="/img/avatar.jpg" class="header-avatar"></a>
		<h1> 苏苏的博客</h1>
		<p class="sub-title">简约至极</p>
		<ul class="contact">
			<a href="https://github.com/suconghou" target="_blank"><i class="fa fa-github"></i></a>
			<a href="javascript:music.show(1)"><i class="fa fa-music"></i></a>
		</ul>
	</div>
</header>

<aside></aside>

<div class="content container">
	<div class="post">
		<h1 class="post-title">
			<a href="javascript:void(0)"> 安装PHP7和NGINX</a>
		</h1>
		<p class="post-date">Fri, Jan 1, 2016</p>
		
			<p class="post-tags">
			
				<a href="/tags/php">#php</a>
			
				<a href="/tags/nginx">#nginx</a>
			
				<a href="/tags/mysql">#mysql</a>
			
				<a href="/tags/redis">#redis</a>
			
				<a href="/tags/memcached">#memcached</a>
			
				<a href="/tags/swoole">#swoole</a>
			
			</p>
		
		<div class="post-text">
			 

<h2 id="编译安装nginx:aa93c013153cd0b80f2e19308ae27e8a">编译安装NGINX</h2>

<p>首先安装一些依赖</p>

<pre><code>yum -y install gcc make autoconf automake install zlib zlib-devel openssl openssl-devel pcre-devel
</code></pre>

<pre><code>apt-get update
apt-get -y install gcc make  openssl libssl-dev libpcre3 libpcre3-dev
</code></pre>

<p>编译安装</p>

<pre><code>cd /tmp
wget http://nginx.org/download/nginx-1.9.14.tar.gz
tar -zxvf nginx-1.9.14.tar.gz
cd nginx-1.9.14
./configure
make &amp;&amp; make install
</code></pre>

<p>还可以添加<a href="https://github.com/cuber/ngx_http_google_filter_module">Google反代模块</a>,按下面操作编译</p>

<pre><code>cd /tmp
git clone https://github.com/cuber/ngx_http_google_filter_module
git clone https://github.com/yaoweibin/ngx_http_substitutions_filter_module
wget http://nginx.org/download/nginx-1.9.14.tar.gz
tar -zxvf nginx-1.9.14.tar.gz
cd nginx-1.9.14
./configure  --with-http_ssl_module  --add-module=/tmp/ngx_http_google_filter_module  --add-module=/tmp/ngx_http_substitutions_filter_module
make &amp;&amp; make install
</code></pre>

<p>注意:重复执行,需要清理上次编译数据<code>make clean</code></p>

<p><code>nginx -V</code> 查看编译的参数和已加载的模块</p>

<pre><code>server {
	listen       80;
	server_name  g.suconghou.cn google.com www.google.com;
	resolver 8.8.8.8;
	expires 1d;
	gzip on;
	gzip_min_length 1024;
	gzip_proxied any;
	gzip_comp_level 3;
	gzip_types text/plain text/javascript text/css text/json application/javascript  application/json image/jpeg image/gif image/png;
	proxy_hide_header Set-Cookie;
	proxy_hide_header Alt-Svc;
	proxy_hide_header Alternate-Protocol;
	location / {
			google on;
			google_scholar on;
	}

}

</code></pre>

<h3 id="各模块说明:aa93c013153cd0b80f2e19308ae27e8a">各模块说明</h3>

<p>http_gzip_module提供了对gzip的基本的支持，默认是编译到nginx的发行版本里面的。</p>

<p>http_gzip_static_module则是针对nginx serve的静态文件，需要编译进去才能有。比如a.html，如果启用了<code>gzip_static on</code>，如果同一目录下还有a.html.gz作为a.html压缩版本存在，那么nginx会以a.html.gz作为a.html的gzip version来serve。</p>

<h3 id="配置gzip:aa93c013153cd0b80f2e19308ae27e8a">配置Gzip</h3>

<p><code>gzip on</code> 开启Gzip</p>

<p><code>gzip_proxied any</code></p>

<h3 id="可能需要移动配置目录:aa93c013153cd0b80f2e19308ae27e8a">可能需要移动配置目录</h3>

<p>在<code>nginx.conf</code>中配置<code>include /usr/local/nginx/conf/conf.d/*.conf;</code></p>

<p>建立目录<code>mkdir /etc/nginx/conf.d</code></p>

<p>使用<code>ln -s /etc/nginx/conf.d /usr/local/nginx/conf/conf.d</code>建立软连接</p>

<h3 id="卸载apache:aa93c013153cd0b80f2e19308ae27e8a">卸载apache</h3>

<p>1.完全卸载使用apt-get安装的apache
1、sudo apt-get remove apache2
2、sudo apt-get remove apache2.2-common
3、sudo apt-get autoremove (此命令会自动卸载PHP)
卸载完成</p>

<p>2.rpm 方式安装的</p>

<pre><code>rpm -qa|grep httpd
</code></pre>

<p>得出结果
httpd-2.2.15-39.el6.centos.i686
httpd-tools-2.2.15-39.el6.centos.i686</p>

<p>从上往下一个一个卸载</p>

<pre><code>rpm -e httpd-2.2.15
rpm -e httpd-tools
</code></pre>

<p>ab压力测试在httpd-tools,可以不卸载;
CenterOS 安装 ab 压力测试</p>

<pre><code>yum install httpd-tools
</code></pre>

<h2 id="编译安装php7:aa93c013153cd0b80f2e19308ae27e8a">编译安装PHP7</h2>

<p>最好先<code>yum update</code>一下,再安装以下依赖</p>

<pre><code>yum install -y git wget curl curl-devel gcc gcc-c++ libmarypt cmake  autoconf libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel libpng libpng-devel libxml2 libxml2-devel zlib zlib-devel glibc glibc-devel glib2 glib2-devel bzip2 bzip2-devel ncurses curl openssl-devel gdbm-devel db4-devel libXpm-devel libX11-devel gd-devel gmp-devel readline-devel libxslt-devel expat-devel xmlrpc-c xmlrpc-c-devel
</code></pre>

<p>下载PHP7最新版本,解压,有多重压缩格式可选,其中xz最小</p>

<pre><code>wget http://php.net/distributions/php-7.0.5.tar.xz
tar -xJf php-7.0.5.tar.xz
cd php-7.0.5
</code></pre>

<p>编译之前,可以开启O3编译优化,生成的可执行文件更小,性能更好
<code>export CFLAGS=&quot;-O3&quot;</code></p>

<p>包含部分常用扩展的编译</p>

<pre><code>./configure --enable-inline-optimization --enable-static=yes --prefix=/tmp --with-config-file-path=/etc --enable-pcntl --enable-sockets --enable-ftp --enable-bcmath --enable-zip --enable-mbstring --with-iconv --with-mysqli --with-pdo-mysql --with-curl --with-gd --with-openssl
</code></pre>

<p>功能更全的编译</p>

<pre><code>export CFLAGS=&quot;-O3&quot;
./configure --enable-inline-optimization --enable-static=yes --prefix=/usr/local --with-config-file-path=/etc --enable-opcache --enable-fpm  --enable-posix --enable-pcntl --enable-sockets --enable-ftp --enable-bcmath  --enable-zip --enable-mbstring --with-iconv --with-mysqli --with-pdo-mysql --with-curl --with-gd  --with-openssl --with-mcrypt
make &amp;&amp; make install
</code></pre>

<p>其中部分步骤可能需要root权限</p>

<h3 id="可能出现的错误:aa93c013153cd0b80f2e19308ae27e8a">可能出现的错误</h3>

<p>1.curl未安装
执行
<code>yum install curl-devel</code>
或者 <code>sudo apt-get install curl libcurl3 libcurl3-dev</code>
然后再次尝试编译</p>

<p>2.需要安装libcrytpt</p>

<pre><code>wget ftp://mcrypt.hellug.gr/pub/crypto/mcrypt/attic/libmcrypt/libmcrypt-2.5.7.tar.gz
</code></pre>

<p>安装：</p>

<pre><code>tar -zxvf libmcrypt-2.5.7.tar.gz
cd libmcrypt-2.5.7
mkdir -p /usr/local/libmcrytpt
./configure prefix=/usr/local/libmcrytpt/
make &amp;&amp; make install
</code></pre>

<p>然后重新编译,设定编译参数mcrypt指定路径:
<code>--with-mcrypt=/usr/local/libmcrytpt/</code></p>

<ol>
<li>OpenSSL相关错误</li>
</ol>

<p><code>Cannot find OpenSSL's &lt;evp.h&gt;</code>
或者</p>

<pre><code>Undefined symbols for architecture x86_64:
  &quot;_PKCS5_PBKDF2_HMAC&quot;, referenced from:
      _zif_openssl_pbkdf2 in openssl.o
  &quot;_SSL_CTX_set_alpn_protos&quot;, referenced from:
      _php_openssl_setup_crypto in xp_ssl.o
  &quot;_SSL_CTX_set_alpn_select_cb&quot;, referenced from:
      _php_openssl_setup_crypto in xp_ssl.o
  &quot;_SSL_get0_alpn_selected&quot;, referenced from:
      _php_openssl_sockop_set_option in xp_ssl.o
  &quot;_SSL_select_next_proto&quot;, referenced from:
      _server_alpn_callback in xp_ssl.o
  &quot;_TLSv1_1_client_method&quot;, referenced from:
      _php_openssl_setup_crypto in xp_ssl.o
  &quot;_TLSv1_1_server_method&quot;, referenced from:
      _php_openssl_setup_crypto in xp_ssl.o
  &quot;_TLSv1_2_client_method&quot;, referenced from:
      _php_openssl_setup_crypto in xp_ssl.o
  &quot;_TLSv1_2_server_method&quot;, referenced from:
      _php_openssl_setup_crypto in xp_ssl.o
</code></pre>

<p>解决:
Linux上 <code>yum install openssl openssl-devel</code></p>

<p>Mac上编译须做如下配置</p>

<p><code>brew install openssl</code> 然后执行 <code>brew link openssl --force</code> 并添加环境变量
<code>export LDFLAGS=&quot;/usr/local/opt/openssl/lib/libssl.dylib /usr/local/opt/openssl/lib/libcrypto.dylib&quot;</code></p>

<p>4.configure: error: xml2-config not found. Please check your libxml2 installation.</p>

<pre><code>apt-get install libxml2 libxml2-dev libmcrypt-dev openssl libssl-dev libcurl4-openssl-dev
</code></pre>

<p>5.Cannot find OpenSSL&rsquo;s libraries</p>

<pre><code>apt-get install libmcrypt-dev openssl libssl-dev libcurl4-openssl-dev
</code></pre>

<p>6.configure: error: png.h not found.</p>

<pre><code>apt-get install libjpeg-dev libpng-dev
</code></pre>

<ol>
<li>make: *** [ext/fileinfo/libmagic/apprentice.lo] Error 1</li>
</ol>

<p>这是由于内存小于1G所导致.可以<code>--disable-fileinfo</code>,或者添加添加零时的swap</p>

<pre><code>#创建一个大小为256M的文件
dd if=/dev/zero of=/swapfile bs=1024 count=262144
#把这个文件变成swap文件
mkswap /swapfile
#启用这个swap文件
swapon /swapfile
</code></pre>

<p>如果要每次开机就加载</p>

<pre><code>#编辑/etc/fstab文件，使在每次开机时自动加载swap文件
/swapfile    swap    swap    default   0 0
</code></pre>

<p>注意:XEN KVM 可以创建SWAP,OVZ本身就是Virtual Environmen,不支持创建SWAP
通过<code>df -lhT</code> 看到Type为simfs,而不是ext3,ext4,一般就不支持</p>

<p>提示: make 可使用多核提升编译性能
用make -j带一个参数，可以把项目进行并行编译，比如在一台双核的机器上，完全可以用<code>make -j4</code>，让make最多允许4个编译命令同时执行，这样可以更有效的利用CPU资源。</p>

<p>-O这个选项控制所有的优化等级。使用优化选项会使编译过程耗费更多的时间，并且占用更多的内存，尤其是在提高优化等级的时候。
-O2是推荐的优化等级,O3是最高等级。如果编译软件出现错误，请先检查是否启用了-O3</p>

<p>PHP的数据库长连接有没有效,
实际测试,采用香港服务器远程连接mysql,非长连接模式下耗时约600ms,使用PDO长连接,耗时下降到260ms左右,是有一定作用的.
但是长连接不适用于CLI模式,CLI模式下,php进程退出,连接即断开.</p>

<h2 id="安装一些其他扩展:aa93c013153cd0b80f2e19308ae27e8a">安装一些其他扩展</h2>

<p>php redis 扩展</p>

<pre><code>wget -c -O php-redis.zip https://github.com/phpredis/phpredis/archive/php7.zip
unzip php-redis.zip
cd phpredis-php7
phpize
./configure --enable-redis-igbinary
make &amp;&amp; make install

</code></pre>

<p>安装libmemcached,memcached依赖此项</p>

<pre><code>wget -c https://launchpad.net/libmemcached/1.0/1.0.18/+download/libmemcached-1.0.18.tar.gz
tar -xzf libmemcached-1.0.18.tar.gz -C /tmp
cd /tmp/libmemcached-1.0.18
./configure
make &amp;&amp; make install
</code></pre>

<p>php memcached 扩展</p>

<pre><code>wget -c -O php-memcached.zip https://github.com/php-memcached-dev/php-memcached/archive/php7.zip
unzip php-memcached.zip
cd php-memcached-php7
phpize
make &amp;&amp; make install
</code></pre>

<p>安装memcached,见<a href="http://memcached.org/downloads">http://memcached.org/downloads</a></p>

<pre><code>wget http://memcached.org/latest
tar -zxvf memcached-1.x.x.tar.gz
cd memcached-1.x.x
./configure &amp;&amp; make &amp;&amp; make test &amp;&amp; sudo make install
</code></pre>

<p>安装swoole扩展</p>

<pre><code>wget -c -O php-swoole.zip https://github.com/swoole/swoole-src/archive/master.zip
unzip php-swoole.zip
cd swoole-src-master
phpize
./configure
make &amp;&amp; make install
</code></pre>

<h2 id="静态编译redis-memcached-opcache到php7:aa93c013153cd0b80f2e19308ae27e8a">静态编译redis,memcached,opcache到php7</h2>

<pre><code>wget -c http://php.net/distributions/php-7.0.5.tar.xz
wget -c -O php-redis.zip https://github.com/phpredis/phpredis/archive/php7.zip
wget -c -O php-memcached.zip https://github.com/php-memcached-dev/php-memcached/archive/php7.zip
tar -xJf php-7.0.5.tar.xz
unzip php-redis.zip -d php-7.0.5/ext
unzip php-memcached.zip -d php-7.0.5/ext
export CFLAGS=&quot;-O3&quot;
cd php-7.0.5
rm -rf configure
./buildconf --force
./configure --help
./configure --enable-inline-optimization --enable-static=yes --prefix=/tmp --with-config-file-path=/etc --enable-opcache --enable-redis --enable-memcached --disable-memcached-sasl --enable-pcntl --enable-sockets --enable-ftp --enable-bcmath --enable-zip --enable-mbstring --with-iconv --with-mysqli --with-pdo-mysql --with-curl --with-gd --with-openssl
make
make install
</code></pre>

<p>可能出现的错误</p>

<p>1.<code>configure: error: no, sasl.h is not available. Run configure with --disable-memcached-sasl to disable this check</code></p>

<p>解决:</p>

<p><code>yum install cyrus-sasl-devel</code> 或 <code>sudo apt-get install libsasl2-dev</code></p>

<p>或者禁用掉</p>

<p>搭配PHP的配置</p>

<pre><code>server{
	listen 8080;
	server_name 127.0.0.1;
	index index.html index.php;
	root /data/sites/default;
	location / {
			try_files $uri $uri/ /index.php?$args;
	}
	location ~ \.php$ {
			try_files $uri /index.php?$args;
			fastcgi_pass  unix:/var/run/php-fpm.sock;
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME  $document_root$fastcgi_script_name;
			include        fastcgi_params;
	}
}

</code></pre>

<p>一个Server实现多个域名,多个主机</p>

<pre><code>server{
	listen 8080;
	server_name *.git.suconghou.cn;
	index index.html index.php;
	if ($host ~* ^((\w+)\.git\.suconghou\.cn)$) {
			set $subdomain $2;
	}
	root /data/git/$subdomain;
	add_header X-Root &quot;$subdomain&quot;;
	location / {
			try_files $uri $uri/ /index.php?$args;
	}
	location ~ \.php$ {
			try_files $uri /index.php?$args;
			fastcgi_pass  unix:/var/run/php-fpm.sock;
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME  $document_root$fastcgi_script_name;
			include        fastcgi_params;
	}

}
</code></pre>

<p>Nginx里同<code>fastcgi_params</code>文件一样,还存在一份配置<code>fastcgi.conf</code>,只不过后者多了一行<code>fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;</code>
我们可以直接使用它来替换<code>fastcgi_params</code>文件配置,同时我们也都添加了try_files检测,也可以略去<code>fastcgi_index</code>,故可以简写为:</p>

<pre><code>location ~ \.php$ {
	try_files $uri /index.php?$args;
	fastcgi_pass  unix:/var/run/php-fpm.sock;
	include fastcgi.conf;
}
</code></pre>

<p>注意<code>fastcgi_param</code>指令是数组型的,内层替换外层,但是同级多次使用的时候，是新增而不是替换。注意不要重复使用.</p>

<p>php-fpm 运行时错误
1. [pool www] cannot get gid for group &lsquo;nobody&rsquo;
<code>groupadd nobody</code>或者
 修改php-fpm.conf</p>

<pre><code>user = www-data
group = www-data
</code></pre>

<h2 id="安装mariadb:aa93c013153cd0b80f2e19308ae27e8a">安装MariaDB</h2>

<pre><code>apt-get install mariadb-server
</code></pre>

<p>MySql</p>

<pre><code>apt-get install mysql-server
</code></pre>

<p>安装过程中要求设定一个root密码,安装完<code>service mysql status</code>查看运行状态,<code>sudo service mysql restart</code>可以重启</p>

<h2 id="开机启动脚本:aa93c013153cd0b80f2e19308ae27e8a">开机启动脚本</h2>

<p>Debian and Ubuntu function at <code>/lib/lsb/init-functions</code>
<code>ln -s  /lib/lsb/init-functions /etc/init.d/functions</code></p>

<p>nginx</p>

<pre><code>#!/bin/sh
#chkconfig: 2345 90 91

binpath=`which nginx`
prog=$(basename $binpath)
. /etc/init.d/functions
. /etc/sysconfig/network
[ &quot;$NETWORKING&quot; = &quot;no&quot; ] &amp;&amp; exit 0
[ -x $binpath ] || exit 0
[ -f /etc/sysconfig/$prog ] &amp;&amp; . /etc/sysconfig/$prog

start(){
	echo -n $&quot;Starting $prog: &quot;
	$prog || echo -n &quot;$prog already running&quot;
}
stop(){
	echo -n $&quot;Stopping $prog: &quot;
	$prog -s quit
}
restart(){
	stop
	sleep 1
	start
}
reload() {
	echo -n $&quot;Reloading $prog: &quot;
	$prog -s reload
}
case &quot;$1&quot; in
start)
    $1
    ;;
stop)
    $1
    ;;
restart)
    $1
    ;;
reload)
    $1
    ;;
*)
echo $&quot;Usage: $0 {start|stop|restart|reload}&quot;
exit 2
esac
</code></pre>

<h3 id="php-fpm:aa93c013153cd0b80f2e19308ae27e8a">php-fpm</h3>

<p><code>sudo vim /etc/init.d/php-fpm</code></p>

<pre><code>#!/bin/sh
#chkconfig: 2345 90 91

binpath=`which php-fpm`
prog=$(basename $binpath)
. /etc/init.d/functions
. /etc/sysconfig/network
[ &quot;$NETWORKING&quot; = &quot;no&quot; ] &amp;&amp; exit 0
[ -x $binpath ] || exit 0
[ -f /etc/sysconfig/$prog ] &amp;&amp; . /etc/sysconfig/$prog
pidfile=/var/run/php-fpm.pid


start(){
	echo -n $&quot;Starting $prog: &quot;
	$prog || echo -n &quot;$prog already running&quot;
}
stop(){
	echo -n $&quot;Stopping $prog: &quot;
	kill -INT `cat $pidfile`
}
restart(){
	stop
	sleep 1
	start
}
reload() {
	echo -n $&quot;Reloading $prog: &quot;
	kill -USR2 `cat $pidfile`
}
case &quot;$1&quot; in
start)
    $1
    ;;
stop)
    $1
    ;;
restart)
    $1
    ;;
reload)
    $1
    ;;
*)
echo $&quot;Usage: $0 {start|stop|restart|reload}&quot;
exit 2
esac
</code></pre>

<pre><code>##  添加执行权限
sudo chmod a+x /etc/init.d/nginx
sudo chmod a+x /etc/init.d/php-fpm

##  加入服务
sudo chkconfig --add nginx
sudo chkconfig --add php-fpm

##   开机自启
sudo chkconfig nginx on
sudo chkconfig php-fpm on

## 查看是否开机启动

sudo chkconfig --list nginx
</code></pre>

<p>Ubuntu里没有chkconfig
可以使用sysv-rc-conf
<code>sudo apt-get install sysv-rc-conf</code>
然后直接使用 sysv-rc-conf 来管理,或者<code>sudo sysv-rc-conf nginx on</code>直接把<code>/etc/init.d/nginx</code> 加入到系统自动 启动列表中</p>

		</div>
	</div>
</div>
	<div class="music-container">
	<div class="music-header">
	    <a class="fa-button home" href="javascript:music.show(0)"><i class="fa fa-home" title="Home"></i></a>
	    <a class="fa-button next" href="javascript:music.next()"><i class="fa fa-chevron-right" title="Next"></i></a>
	</div>
	<div class="backdrop"></div>
	<div class="music-player">
		<div class="cover">
            <img src="http://p4.music.126.net/ckfEE9UUGcnGHylQJ12ENA==/670702092966093.jpg?param=350y350">
            <div class="foredrag"><i class="fa fa-play"></i></div>
        </div>
        <div class="progress">
            <div class="elapse"></div>
        </div>
        <div class="detail">
            <div class="title">音乐标题</div>
            <div class="artist">歌手</div>
        </div>
	</div>
</div>
<div id="loader" style="z-index:99999;" class="pageload-overlay" data-opening="M 40 -21.875 C 11.356078 -21.875 -11.875 1.3560784 -11.875 30 C -11.875 58.643922 11.356078 81.875 40 81.875 C 68.643922 81.875 91.875 58.643922 91.875 30 C 91.875 1.3560784 68.643922 -21.875 40 -21.875 Z">
    <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 80 60" preserveAspectRatio="xMidYMid slice"> <path d="M40,30 c 0,0 0,0 0,0 0,0 0,0 0,0 0,0 0,0 0,0 0,0 0,0 0,0 Z"/></svg>
</div>

	<footer class="footer">
		<div class="footer-nav">
			<ul>
				<li><a href="/post/">归档</a></li>
				<li><a href="/">专题</a></li>
				<li><a href="/life/">生活</a></li>
				<li><a href="/about/">关于</a></li>
			</ul>
		</div>
	</footer>
	<script type="text/javascript" src="/js/main.min.js" data-no-instant></script>
</body>
</html>


